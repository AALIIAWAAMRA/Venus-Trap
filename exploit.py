"""Traffic simulator used to exercise Venus Trap services in labs."""

from __future__ import annotations

import argparse
import socket
from pathlib import Path

import requests


def simulate_http(host: str, port: int, username: str, password: str) -> None:
    url = f"http://{host}:{port}/submit"
    payload = {"un": username, "pw": password}
    response = requests.post(url, data=payload, timeout=5)
    print(f"[HTTP] {url} -> {response.status_code}")


def simulate_ftp(host: str, port: int, username: str, password: str) -> None:
    with socket.create_connection((host, port), timeout=5) as conn:
        banner = conn.recv(2048)
        print(f"[FTP] banner: {banner.decode(errors='ignore').strip()}")

        for cmd in [f"USER {username}\r\n", f"PASS {password}\r\n", "PWD\r\n", "LIST\r\n", "QUIT\r\n"]:
            conn.sendall(cmd.encode())
            reply = conn.recv(2048)
            print(f"[FTP] {cmd.strip()} -> {reply.decode(errors='ignore').strip()}")


def simulate_xmpp(host: str, port: int) -> None:
    with socket.create_connection((host, port), timeout=5) as conn:
        conn.sendall(b"<message from='bot'>new campaign beacon</message>\n")
        print(f"[XMPP] {conn.recv(2048).decode(errors='ignore').strip()}")
        conn.sendall(b"</stream:stream>\n")


def submit_sample(host: str, port: int, sample_path: str) -> None:
    url = f"http://{host}:{port}/submit"
    file_path = Path(sample_path)
    if not file_path.exists():
        raise FileNotFoundError(f"Sample not found: {sample_path}")

    with file_path.open("rb") as stream:
        response = requests.post(
            url,
            files={"sample": (file_path.name, stream, "application/octet-stream")},
            data={"reported_by": "exploit-simulator"},
            timeout=8,
        )

    print(f"[Binary Collector] {url} -> {response.status_code} {response.text}")


def main() -> None:
    parser = argparse.ArgumentParser(description="Venus Trap simulator")
    parser.add_argument("--host", default="127.0.0.1")
    parser.add_argument("--http-port", type=int, default=8080)
    parser.add_argument("--ftp-port", type=int, default=2121)
    parser.add_argument("--xmpp-port", type=int, default=5222)
    parser.add_argument("--collector-port", type=int, default=9090)
    parser.add_argument("--username", default="hameid")
    parser.add_argument("--password", default="123456")
    parser.add_argument("--sample", default="server.key.pub")
    args = parser.parse_args()

    simulate_http(args.host, args.http_port, args.username, args.password)
    simulate_ftp(args.host, args.ftp_port, args.username, args.password)
    simulate_xmpp(args.host, args.xmpp_port)
    submit_sample(args.host, args.collector_port, args.sample)


if __name__ == "__main__":
    main()
